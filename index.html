<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Electoral Avanzado</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: auto; }
        header { text-align: center; margin-bottom: 30px; }
        
        /* Estilo de los filtros (Parecido a Excel) */
        .filters-bar { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        .filter-item { display: flex; flex-direction: column; }
        label { font-weight: bold; font-size: 0.9em; margin-bottom: 5px; color: #666; }
        select { padding: 10px; border-radius: 5px; border: 1px solid #ddd; background: #fff; cursor: pointer; }

        /* Layout de Gr谩ficos */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }
        .chart-card { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            min-height: 400px;
        }
        .full-width { grid-column: 1 / -1; }
        h3 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 1.1em; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Monitor de Aprobaci贸n de Gobernadores</h1>
    </header>

    <div class="filters-bar">
        <div class="filter-item">
            <label>1. Seleccionar Estado / Gobernador:</label>
            <select id="selEstado"></select>
        </div>
        <div class="filter-item">
            <label>2. Encuestadora (Filtro Global):</label>
            <select id="selEncuesta"></select>
        </div>
        <div class="filter-item">
            <label>3. Fecha de Corte (para Rankings):</label>
            <select id="selFecha"></select>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="chart-card full-width">
            <h3> Seguimiento Hist贸rico de Aprobaci贸n (Estado Seleccionado)</h3>
            <canvas id="chartHistorico"></canvas>
        </div>

        <div class="chart-card">
            <h3> Ranking Nacional (En la Fecha Seleccionada)</h3>
            <canvas id="chartRanking"></canvas>
        </div>

        <div class="chart-card">
            <h3>锔 Comparativa por Encuestadora (Estado y Fecha Seleccionada)</h3>
            <canvas id="chartEncuestas"></canvas>
        </div>
    </div>
</div>

<script>
    let rawData = [];
    let chartH, chartR, chartE;

    // Cargar Datos
    Papa.parse('datos.csv', {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function(results) {
            // Ordenar por fecha cronol贸gicamente de inicio
            rawData = results.data.sort((a, b) => new Date(a.Mes) - new Date(b.Mes));
            initApp();
        }
    });

    function initApp() {
        const estados = [...new Set(rawData.map(d => d.Estado))].sort();
        const encuestas = [...new Set(rawData.map(d => d.Encuesta))].sort();
        const fechas = [...new Set(rawData.map(d => d.Mes))]; // Ya vienen ordenadas por el sort inicial

        populateSelect('selEstado', estados);
        populateSelect('selEncuesta', encuestas);
        populateSelect('selFecha', fechas.reverse()); // La m谩s reciente primero para el ranking

        // Listeners
        document.querySelectorAll('select').forEach(s => s.addEventListener('change', updateAllCharts));
        
        updateAllCharts();
    }

    function populateSelect(id, items) {
        const sel = document.getElementById(id);
        items.forEach(item => sel.add(new Option(item, item)));
    }

    function updateAllCharts() {
        const estado = document.getElementById('selEstado').value;
        const encuesta = document.getElementById('selEncuesta').value;
        const fecha = document.getElementById('selFecha').value;

        renderHistorico(estado, encuesta);
        renderRanking(fecha, encuesta);
        renderPorEncuestadora(estado, fecha);
    }

    // --- GRFICO 1: LNEAS (HISTRICO) ---
    function renderHistorico(estado, encuesta) {
        const data = rawData.filter(d => d.Estado === estado && d.Encuesta === encuesta);
        const labels = data.map(d => d.Mes);
        const values = data.map(d => (d.Aprobaci贸n * 100).toFixed(1));

        if (chartH) chartH.destroy();
        chartH = new Chart(document.getElementById('chartHistorico'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `Aprobaci贸n de ${estado} (${encuesta})`,
                    data: values,
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 5
                }]
            },
            options: { scales: { y: { min: 0, max: 100 } } }
        });
    }

    // --- GRFICO 2: BARRAS (RANKING) ---
    function renderRanking(fecha, encuesta) {
        const data = rawData.filter(d => d.Mes === fecha && d.Encuesta === encuesta)
                            .sort((a, b) => b.Aprobaci贸n - a.Aprobaci贸n);
        
        if (chartR) chartR.destroy();
        chartR = new Chart(document.getElementById('chartRanking'), {
            type: 'bar',
            data: {
                labels: data.map(d => d.Estado),
                datasets: [{
                    label: '% Aprobaci贸n',
                    data: data.map(d => (d.Aprobaci贸n * 100).toFixed(1)),
                    backgroundColor: '#4CAF50'
                }]
            },
            options: { indexAxis: 'y', scales: { x: { max: 100 } } }
        });
    }

    // --- GRFICO 3: BARRAS (POR ENCUESTADORA) ---
    function renderPorEncuestadora(estado, fecha) {
        const data = rawData.filter(d => d.Estado === estado && d.Mes === fecha);
        
        if (chartE) chartE.destroy();
        chartE = new Chart(document.getElementById('chartEncuestas'), {
            type: 'bar',
            data: {
                labels: data.map(d => d.Encuesta),
                datasets: [{
                    label: 'Aprobaci贸n por Casa Encuestadora',
                    data: data.map(d => (d.Aprobaci贸n * 100).toFixed(1)),
                    backgroundColor: '#FF9800'
                }]
            },
            options: { scales: { y: { max: 100, beginAtZero: true } } }
        });
    }
</script>
</body>
</html>
