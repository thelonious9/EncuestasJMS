<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero Electoral Profesional</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f1f2f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: auto; }
        
        .filters-bar { 
            display: flex; flex-wrap: wrap; gap: 15px; background: white; 
            padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 25px; border-top: 5px solid var(--accent);
        }
        .filter-item { flex: 1; min-width: 250px; display: flex; flex-direction: column; }
        label { font-size: 0.8rem; font-weight: bold; margin-bottom: 8px; color: #57606f; }
        select { padding: 12px; border-radius: 8px; border: 1px solid #ced4da; background: #fff; font-size: 14px; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 25px; }
        .chart-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .full-width { grid-column: 1 / -1; }
        
        /* Contenedores de gr치ficos */
        .canvas-holder { position: relative; width: 100%; height: 400px; }
        .ranking-scroll { height: 600px; overflow-y: auto; border: 1px solid #f1f2f6; padding: 10px; border-radius: 8px; }
        
        h3 { margin: 0 0 20px 0; font-size: 1.1rem; color: var(--primary); display: flex; justify-content: space-between; }
        #status-msg { position: fixed; top: 0; left: 0; width: 100%; padding: 10px; background: #2ecc71; color: white; text-align: center; display: none; z-index: 9999; }
        .error-msg { background: #e74c3c !important; }
    </style>
</head>
<body>

<div id="status-msg">Cargando datos...</div>

<div class="container">
    <header style="text-align: center; margin-bottom: 30px;">
        <h1 style="margin:0; color: var(--primary);">Monitor de Aprobaci칩n de Gobernadores</h1>
        <p style="color: #7f8c8d;">An치lisis comparativo de casas encuestadoras y rankings estatales</p>
    </header>

    <div class="filters-bar">
        <div class="filter-item">
            <label>游늸 SELECCIONAR ESTADO</label>
            <select id="selEstado"></select>
        </div>
        <div class="filter-item">
            <label>游댌 CASA ENCUESTADORA</label>
            <select id="selEncuesta"></select>
        </div>
        <div class="filter-item">
            <label>游늰 FECHA DE CORTE</label>
            <select id="selFecha"></select>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="chart-card full-width">
            <h3>游늳 Seguimiento Hist칩rico <small id="avgH" style="font-weight: normal; color: #7f8c8d;"></small></h3>
            <div class="canvas-holder">
                <canvas id="chartHistorico"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <h3>游끥 Ranking Nacional (Posiciones) <small id="avgR" style="font-weight: normal; color: #7f8c8d;"></small></h3>
            <div class="ranking-scroll">
                <canvas id="chartRanking"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <h3>丘뒲잺 Comparativa entre Encuestadoras <small id="avgE" style="font-weight: normal; color: #7f8c8d;"></small></h3>
            <div class="canvas-holder">
                <canvas id="chartEncuestas"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    // IMPORTANTE: Registrar el plugin de anotaciones para Chart.js 4
    Chart.register(window['chartjs-plugin-annotation']);

    let rawData = [];
    let charts = {};
    const CSV_NAME = 'datos.csv'; // Verifica que se llame exactamente as칤 en GitHub

    // Iniciar Carga
    showStatus("Cargando archivo CSV...");
    Papa.parse(CSV_NAME, {
        download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
        complete: function(results) {
            if(results.data.length === 0) {
                showStatus("ERROR: El archivo CSV est치 vac칤o o no se encontr칩.", true);
                return;
            }
            // Filtrar datos v치lidos
            rawData = results.data.filter(d => d.Estado && d.Aprobaci칩n != null);
            console.log("Datos cargados:", rawData.length);
            initApp();
        },
        error: function() { showStatus("ERROR: No se pudo leer el archivo 'datos.csv'.", true); }
    });

    function showStatus(msg, isError = false) {
        const el = document.getElementById('status-msg');
        el.innerText = msg;
        el.style.display = 'block';
        if(isError) el.classList.add('error-msg');
        else setTimeout(() => el.style.display = 'none', 3000);
    }

    function initApp() {
        const estados = [...new Set(rawData.map(d => d.Estado))].sort();
        const encuestas = [...new Set(rawData.map(d => d.Encuesta))].sort();
        const fechas = [...new Set(rawData.map(d => d.Mes))].sort().reverse();

        populate('selEstado', estados, false);
        populate('selEncuesta', encuestas, true);
        populate('selFecha', fechas, true);

        document.querySelectorAll('select').forEach(s => s.onchange = updateAll);
        updateAll();
    }

    function populate(id, items, hasAll) {
        const sel = document.getElementById(id);
        if(hasAll) sel.add(new Option("--- TODAS LAS OPCIONES ---", "Todas"));
        items.forEach(i => sel.add(new Option(i, i)));
    }

    function updateAll() {
        const est = document.getElementById('selEstado').value;
        const enc = document.getElementById('selEncuesta').value;
        const fec = document.getElementById('selFecha').value;

        // 1. Datos Hist칩rico
        let dH = rawData.filter(d => d.Estado === est);
        if(enc !== "Todas") dH = dH.filter(d => d.Encuesta === enc);
        const resH = process(dH.sort((a,b)=>new Date(a.Mes)-new Date(b.Mes)), 'Mes');
        render('chartHistorico', 'line', resH, '#3498db', 'x', 'avgH');

        // 2. Datos Ranking
        let dR = rawData;
        if(fec !== "Todas") dR = dR.filter(d => d.Mes === fec);
        if(enc !== "Todas") dR = dR.filter(d => d.Encuesta === enc);
        const ranking = process(dR, 'Estado').sort((a,b) => b.val - a.val);
        const rankedData = {
            labels: ranking.map((item, i) => `${i + 1}. ${item.label}`),
            values: ranking.map(i => i.val)
        };
        render('chartRanking', 'bar', rankedData, '#2ecc71', 'y', 'avgR');

        // 3. Datos Encuestas
        let dE = rawData.filter(d => d.Estado === est);
        if(fec !== "Todas") dE = dE.filter(d => d.Mes === fec);
        const comp = process(dE, 'Encuesta').sort((a,b) => b.val - a.val);
        render('chartEncuestas', 'bar', comp, '#9b59b6', 'x', 'avgE');
    }

    function process(data, field) {
        const map = new Map();
        data.forEach(d => {
            const key = d[field];
            if(!map.has(key)) map.set(key, { sum: 0, count: 0 });
            map.get(key).sum += d.Aprobaci칩n;
            map.get(key).count++;
        });
        return Array.from(map.keys()).map(k => ({ label: k, val: ((map.get(k).sum / map.get(k).count) * 100).toFixed(1) }));
    }

    function render(id, type, data, color, axis, avgLabelId) {
        const labels = data.labels || data.map(i => i.label);
        const values = data.values || data.map(i => i.val);
        
        // Calcular Promedio para la l칤nea
        const sum = values.reduce((a, b) => a + parseFloat(b), 0);
        const avg = values.length > 0 ? (sum / values.length).toFixed(1) : 0;
        document.getElementById(avgLabelId).innerText = `| Promedio: ${avg}%`;

        if(charts[id]) charts[id].destroy();

        const canvas = document.getElementById(id);
        if(id === 'chartRanking') canvas.height = Math.max(labels.length * 30, 400);

        charts[id] = new Chart(canvas.getContext('2d'), {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: id === 'chartRanking' ? values.map(v => v > 50 ? '#27ae60' : '#e74c3c') : color,
                    borderColor: color, fill: type === 'line', tension: 0.3
                }]
            },
            options: {
                indexAxis: axis,
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                [axis === 'y' ? 'xMin' : 'yMin']: avg,
                                [axis === 'y' ? 'xMax' : 'yMax']: avg,
                                borderColor: '#2d3436',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    display: true, content: 'Promedio: ' + avg + '%',
                                    position: 'end', backgroundColor: 'rgba(45, 52, 54, 0.8)'
                                }
                            }
                        }
                    }
                },
                scales: { 
                    y: { beginAtZero: true, max: axis === 'x' ? 100 : undefined },
                    x: { max: axis === 'y' ? 100 : undefined }
                }
            }
        });
    }
</script>
</body>
</html>
